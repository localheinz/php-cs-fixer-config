language: php

sudo: false

env:
  global:
    - secure: "WK9kQNN8xu2cBLAHCpgHYqoEF4Uuj2Q7c81EfDO3wJulGkR/NmKy5+KxwmwnPfVQTE/64FCAJJHMQefQIIe+JfQLn9X1SfIn0RYfj8UUtJw7DSMj0GD175fC23ThUt9fX/rubMjVvOxlC6ll/QAXeAWS1wERA1FrewC0i/x3/Z4I4NJ9lSeMRbE5tEzsvtwLfzR47hbvL4UFcziSg5vglzF1tyaEp8rYRihIT5jYcsprHSHmCIaRh6CIT+iixvofQQP2wfYg19jWfmBFlzeTk7GC5BE5IH7FInHOJq17+BRlHSPTCEZpqUhdewKcnHFWTuwfl2UXwvqJfU70Zj+7i/uGfr8u2kgK6WRW1FtyBLKkxdm4aZJdVhhMlTV6IsEtt1D6Rbg/UVyaFRZ/V+CxGm+Zi1+QtgTT66C9p73I5+j4YkXQUKpdG8yMnmVFDyf6Stl221XbXrjU3UPrCzTno/7Xaqr+IOfK4MNCZAhxfBW7c7HirhgQzZ9ym+YLbl4uAdc/uHJMGYESdBG/IQPUffVec5L8TbCuEH6iOgBj1WAZ4+P1wi2gLiCyaPB2WpMakCyErPc5QzPa6xUg1XCEP9FtmXPd8iWDIHHcLiZ5lke9ySHhCfj1CEX7VqXVHm+e8ui6FmXa2MKTGok0Bj/YZ1NIevu9ocIEN811qv9Xifk="

cache:
  directories:
    - $HOME/.composer/cache
    - $HOME/.php-cs-fixer

stages:
  - style
  - test

jobs:
  include:
    - stage: Style

      php: 5.6

      before_install:
        - source .travis/xdebug.sh
        - xdebug-disable
        - composer validate
        - if [[ -n "$GITHUB_TOKEN" ]]; then composer config github-oauth.github.com $GITHUB_TOKEN; fi

      install:
        - composer install

      before_script:
        - mkdir -p $HOME/.php-cs-fixer

      script:
        - vendor/bin/php-cs-fixer fix --config=.php_cs --diff --dry-run --verbose

    - &TEST

      stage: Test

      php: 5.6

      env: WITH_LOWEST=true

      before_install:
        - source .travis/xdebug.sh
        - xdebug-disable
        - composer validate
        - if [[ -n "$GITHUB_TOKEN" ]]; then composer config github-oauth.github.com $GITHUB_TOKEN; fi

      install:
        - if [[ "$WITH_LOWEST" == "true" ]]; then composer update --prefer-lowest; fi
        - if [[ "$WITH_LOCKED" == "true" ]]; then composer install; fi
        - if [[ "$WITH_HIGHEST" == "true" ]]; then composer update; fi

      script:
        - if [[ "$WITH_COVERAGE" == "true" ]]; then xdebug-enable; fi
        - if [[ "$WITH_COVERAGE" == "true" ]]; then vendor/bin/phpunit --configuration=test/Unit/phpunit.xml --coverage-clover=build/logs/clover.xml; else vendor/bin/phpunit --configuration=test/Unit/phpunit.xml; fi
        - if [[ "$WITH_COVERAGE" == "true" ]]; then xdebug-disable; fi

      after_success:
        - if [[ "$WITH_COVERAGE" == "true" ]]; then bash <(curl -s https://codecov.io/bash); fi

    - <<: *TEST

      php: 5.6

      env: WITH_LOCKED=true

    - <<: *TEST

      php: 5.6

      env: WITH_HIGHEST=true

    - <<: *TEST

      php: 7.0

      env: WITH_LOWEST=true

    - <<: *TEST

      php: 7.0

      env: WITH_LOCKED=true

    - <<: *TEST

      php: 7.0

      env: WITH_HIGHEST=true

    - <<: *TEST

      php: 7.1

      env: WITH_LOWEST=true

    - <<: *TEST

      php: 7.1

      env: WITH_LOCKED=true WITH_COVERAGE=true

    - <<: *TEST

      php: 7.1

      env: WITH_HIGHEST=true

    - <<: *TEST

      php: 7.2

      env: WITH_LOWEST=true

    - <<: *TEST

      php: 7.2

      env: WITH_LOCKED=true

    - <<: *TEST

      php: 7.2

      env: WITH_HIGHEST=true

notifications:
  email: false
